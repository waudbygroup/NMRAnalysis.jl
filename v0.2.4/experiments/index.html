<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Creating new experiments · NMRAnalysis.jl</title><meta name="title" content="Creating new experiments · NMRAnalysis.jl"/><meta property="og:title" content="Creating new experiments · NMRAnalysis.jl"/><meta property="twitter:title" content="Creating new experiments · NMRAnalysis.jl"/><meta name="description" content="Documentation for NMRAnalysis.jl."/><meta property="og:description" content="Documentation for NMRAnalysis.jl."/><meta property="twitter:description" content="Documentation for NMRAnalysis.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">NMRAnalysis.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../r1rho/">R1ρ</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../tutorials/r1rho/">R1ρ analysis</a></li></ul></li><li><span class="tocitem">Reference guide</span><ul><li class="is-active"><a class="tocitem" href>Creating new experiments</a><ul class="internal"><li><a class="tocitem" href="#Required-Fields"><span>Required Fields</span></a></li><li><a class="tocitem" href="#Required-Implementation"><span>Required Implementation</span></a></li><li><a class="tocitem" href="#Default-Implementations"><span>Default Implementations</span></a></li><li><a class="tocitem" href="#Functions-Handled-by-Abstract-Type"><span>Functions Handled by Abstract Type</span></a></li><li><a class="tocitem" href="#Implemented-Experiment-Types"><span>Implemented Experiment Types</span></a></li><li><a class="tocitem" href="#Guide:-Creating-a-New-Experiment-Type"><span>Guide: Creating a New Experiment Type</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../indexes/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Reference guide</a></li><li class="is-active"><a href>Creating new experiments</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Creating new experiments</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/waudbygroup/NMRAnalysis.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/waudbygroup/NMRAnalysis.jl/blob/main/docs/src/experiments.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="2D-Experiments"><a class="docs-heading-anchor" href="#2D-Experiments">2D Experiments</a><a id="2D-Experiments-1"></a><a class="docs-heading-anchor-permalink" href="#2D-Experiments" title="Permalink"></a></h1><p>An abstract type representing a type of experimental NMR analysis. The type system is split between fixed-peak experiments (where peak positions are constant between spectra) and moving-peak experiments (where peak positions can vary).</p><h2 id="Required-Fields"><a class="docs-heading-anchor" href="#Required-Fields">Required Fields</a><a id="Required-Fields-1"></a><a class="docs-heading-anchor-permalink" href="#Required-Fields" title="Permalink"></a></h2><p>All concrete subtypes must include the following fields:</p><ul><li><code>specdata</code>: A <code>SpecData</code> object containing the observed and simulated data plus mask</li><li><code>peaks</code>: An <code>Observable</code> list of peaks in the experiment</li><li><code>clusters</code>: An <code>Observable</code> list of clusters of peaks</li><li><code>touched</code>: An <code>Observable</code> list of touched clusters</li><li><code>isfitting</code>: An <code>Observable</code> boolean indicating if real-time fitting is active</li><li><code>xradius</code>: An <code>Observable</code> number defining peak detection radius in x dimension</li><li><code>yradius</code>: An <code>Observable</code> number defining peak detection radius in y dimension</li><li><code>state</code>: An <code>Observable</code> dictionary of GUI state variables</li></ul><h2 id="Required-Implementation"><a class="docs-heading-anchor" href="#Required-Implementation">Required Implementation</a><a id="Required-Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Required-Implementation" title="Permalink"></a></h2><p>Concrete subtypes must implement both the core analysis functions below and the visualization functions documented separately. Note that many other functions have default implementations that can be used unless special behaviour is needed.</p><h3 id="Type-Hierarchy"><a class="docs-heading-anchor" href="#Type-Hierarchy">Type Hierarchy</a><a id="Type-Hierarchy-1"></a><a class="docs-heading-anchor-permalink" href="#Type-Hierarchy" title="Permalink"></a></h3><p>The <code>Experiment</code> type has two immediate subtypes that handle position behaviour:</p><ul><li><code>FixedPeakExperiment</code>: Implementation where <code>hasfixedpositions(expt) = true</code></li><li><code>MovingPeakExperiment</code>: Implementation where <code>hasfixedpositions(expt) = false</code></li></ul><p>Concrete experiment types should inherit from one of these intermediate types rather than directly from <code>Experiment</code>.</p><h3 id="addpeak!(expt,-position,-[label],-[xradius],-[yradius])"><a class="docs-heading-anchor" href="#addpeak!(expt,-position,-[label],-[xradius],-[yradius])"><code>addpeak!(expt, position, [label], [xradius], [yradius])</code></a><a id="addpeak!(expt,-position,-[label],-[xradius],-[yradius])-1"></a><a class="docs-heading-anchor-permalink" href="#addpeak!(expt,-position,-[label],-[xradius],-[yradius])" title="Permalink"></a></h3><p>Add a new peak to the experiment at the specified position.</p><p><strong>Arguments:</strong></p><ul><li><code>expt</code>: The experiment</li><li><code>position</code>: A <code>Point2f</code> specifying the (x,y) coordinates of the peak</li><li><code>label</code>: Optional string label for the peak (defaults to auto-generated)</li><li><code>xradius</code>: Optional peak radius in x dimension (defaults to experiment default)</li><li><code>yradius</code>: Optional peak radius in y dimension (defaults to experiment default)</li></ul><h3 id="simulate!(z,-peak,-expt,-[xbounds],-[ybounds])"><a class="docs-heading-anchor" href="#simulate!(z,-peak,-expt,-[xbounds],-[ybounds])"><code>simulate!(z, peak, expt, [xbounds], [ybounds])</code></a><a id="simulate!(z,-peak,-expt,-[xbounds],-[ybounds])-1"></a><a class="docs-heading-anchor-permalink" href="#simulate!(z,-peak,-expt,-[xbounds],-[ybounds])" title="Permalink"></a></h3><p>Simulate a single peak in the experiment.</p><p><strong>Arguments:</strong></p><ul><li><code>z</code>: Array to store simulation results</li><li><code>peak</code>: The peak to simulate</li><li><code>expt</code>: The experiment</li><li><code>xbounds</code>: Optional bounds for x dimension simulation</li><li><code>ybounds</code>: Optional bounds for y dimension simulation</li></ul><h2 id="Default-Implementations"><a class="docs-heading-anchor" href="#Default-Implementations">Default Implementations</a><a id="Default-Implementations-1"></a><a class="docs-heading-anchor-permalink" href="#Default-Implementations" title="Permalink"></a></h2><p>The abstract type provides several default implementations that can be used as-is or overridden when needed:</p><h3 id="mask!(z,-peak,-expt)"><a class="docs-heading-anchor" href="#mask!(z,-peak,-expt)"><code>mask!(z, peak, expt)</code></a><a id="mask!(z,-peak,-expt)-1"></a><a class="docs-heading-anchor-permalink" href="#mask!(z,-peak,-expt)" title="Permalink"></a></h3><p>Default implementation generates an elliptical mask for each peak using <code>maskellipse!</code>. Only needs to be overridden if a different peak shape is required.</p><p><strong>Arguments:</strong></p><ul><li><code>z</code>: Array to store mask results</li><li><code>peak</code>: The peak to mask</li><li><code>expt</code>: The experiment</li></ul><h3 id="postfit!(peak,-expt)"><a class="docs-heading-anchor" href="#postfit!(peak,-expt)"><code>postfit!(peak, expt)</code></a><a id="postfit!(peak,-expt)-1"></a><a class="docs-heading-anchor-permalink" href="#postfit!(peak,-expt)" title="Permalink"></a></h3><p>Perform additional fitting operations after spectrum fitting.</p><p><strong>Arguments:</strong></p><ul><li><code>peak</code>: The peak to post-fit</li><li><code>expt</code>: The experiment</li></ul><h3 id="slicelabel(expt,-idx)"><a class="docs-heading-anchor" href="#slicelabel(expt,-idx)"><code>slicelabel(expt, idx)</code></a><a id="slicelabel(expt,-idx)-1"></a><a class="docs-heading-anchor-permalink" href="#slicelabel(expt,-idx)" title="Permalink"></a></h3><p>Generate a label for a specific slice/plane of the experiment.</p><p><strong>Arguments:</strong></p><ul><li><code>expt</code>: The experiment</li><li><code>idx</code>: The slice index</li></ul><p><strong>Returns:</strong></p><ul><li>A string label for the slice</li></ul><h3 id="peakinfotext(expt,-idx)"><a class="docs-heading-anchor" href="#peakinfotext(expt,-idx)"><code>peakinfotext(expt, idx)</code></a><a id="peakinfotext(expt,-idx)-1"></a><a class="docs-heading-anchor-permalink" href="#peakinfotext(expt,-idx)" title="Permalink"></a></h3><p>Generate information text about a specific peak.</p><p><strong>Arguments:</strong></p><ul><li><code>expt</code>: The experiment</li><li><code>idx</code>: The peak index</li></ul><p><strong>Returns:</strong></p><ul><li>A string containing formatted peak information</li></ul><h3 id="experimentinfo(expt)"><a class="docs-heading-anchor" href="#experimentinfo(expt)"><code>experimentinfo(expt)</code></a><a id="experimentinfo(expt)-1"></a><a class="docs-heading-anchor-permalink" href="#experimentinfo(expt)" title="Permalink"></a></h3><p>Generate information text about the experiment.</p><p><strong>Returns:</strong></p><ul><li>A string containing formatted experiment information</li></ul><h3 id="completestate!(state,-expt)"><a class="docs-heading-anchor" href="#completestate!(state,-expt)"><code>completestate!(state, expt)</code></a><a id="completestate!(state,-expt)-1"></a><a class="docs-heading-anchor-permalink" href="#completestate!(state,-expt)" title="Permalink"></a></h3><p>Set up observables for the GUI state.</p><p><strong>Arguments:</strong></p><ul><li><code>state</code>: The GUI state dictionary</li><li><code>expt</code>: The experiment</li></ul><h2 id="Functions-Handled-by-Abstract-Type"><a class="docs-heading-anchor" href="#Functions-Handled-by-Abstract-Type">Functions Handled by Abstract Type</a><a id="Functions-Handled-by-Abstract-Type-1"></a><a class="docs-heading-anchor-permalink" href="#Functions-Handled-by-Abstract-Type" title="Permalink"></a></h2><p>The following functions are implemented generically and do not need to be reimplemented by concrete subtypes:</p><h3 id="Peak-Management"><a class="docs-heading-anchor" href="#Peak-Management">Peak Management</a><a id="Peak-Management-1"></a><a class="docs-heading-anchor-permalink" href="#Peak-Management" title="Permalink"></a></h3><ul><li><code>nslices(expt)</code>: Get the number of slices in the experiment</li><li><code>npeaks(expt)</code>: Get the number of peaks in the experiment</li><li><code>movepeak!(expt, idx, newpos)</code>: Move a peak to a new position</li><li><code>deletepeak!(expt, idx)</code>: Delete a specific peak</li><li><code>deleteallpeaks!(expt)</code>: Delete all peaks</li></ul><h3 id="Data-Processing"><a class="docs-heading-anchor" href="#Data-Processing">Data Processing</a><a id="Data-Processing-1"></a><a class="docs-heading-anchor-permalink" href="#Data-Processing" title="Permalink"></a></h3><ul><li><code>mask!(z, peaks, expt)</code>: Calculate peak masks and update internal specdata</li><li><code>simulate!(z, peaks, expt)</code>: Simulate the experiment and update internal specdata</li><li><code>fit!(expt)</code>: Fit the peaks in the experiment</li><li><code>fit!(cluster, expt)</code>: Fit a specific cluster of peaks</li><li><code>checktouched!(expt)</code>: Check which clusters have been modified</li></ul><h3 id="Observable-Setup"><a class="docs-heading-anchor" href="#Observable-Setup">Observable Setup</a><a id="Observable-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Observable-Setup" title="Permalink"></a></h3><ul><li><code>setupexptobservables!(expt)</code>: Set up reactive behaviours for experiment observables</li></ul><h3 id="Required-Visualization-Functions"><a class="docs-heading-anchor" href="#Required-Visualization-Functions">Required Visualization Functions</a><a id="Required-Visualization-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Required-Visualization-Functions" title="Permalink"></a></h3><p>Concrete subtypes must implement the following visualization functions:</p><h3 id="makepeakplot!(gui,-state,-expt)"><a class="docs-heading-anchor" href="#makepeakplot!(gui,-state,-expt)"><code>makepeakplot!(gui, state, expt)</code></a><a id="makepeakplot!(gui,-state,-expt)-1"></a><a class="docs-heading-anchor-permalink" href="#makepeakplot!(gui,-state,-expt)" title="Permalink"></a></h3><p>Create the interactive peak plot in the GUI context. This function is crucial for real-time visualization and interaction.</p><p><strong>Arguments:</strong></p><ul><li><code>gui</code>: The GUI context containing plot panels</li><li><code>state</code>: The GUI state dictionary</li><li><code>expt</code>: The experiment</li></ul><h3 id="save_peak_plots!(expt,-folder)"><a class="docs-heading-anchor" href="#save_peak_plots!(expt,-folder)"><code>save_peak_plots!(expt, folder)</code></a><a id="save_peak_plots!(expt,-folder)-1"></a><a class="docs-heading-anchor-permalink" href="#save_peak_plots!(expt,-folder)" title="Permalink"></a></h3><p>Save publication-quality plots for all peaks to a specified folder.</p><p><strong>Arguments:</strong></p><ul><li><code>expt</code>: The experiment</li><li><code>folder</code>: String path to the output folder</li></ul><h3 id="Utility-Functions"><a class="docs-heading-anchor" href="#Utility-Functions">Utility Functions</a><a id="Utility-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Utility-Functions" title="Permalink"></a></h3><ul><li><code>bounds(mask)</code>: Calculate bounds from a mask</li><li><code>peak_plot_data(peak, expt)</code>: Extract plotting data for a single peak</li><li><code>plot_peak!(ax, peak, expt)</code>: Plot a single peak&#39;s data</li></ul><h2 id="Implemented-Experiment-Types"><a class="docs-heading-anchor" href="#Implemented-Experiment-Types">Implemented Experiment Types</a><a id="Implemented-Experiment-Types-1"></a><a class="docs-heading-anchor-permalink" href="#Implemented-Experiment-Types" title="Permalink"></a></h2><p>The codebase includes implementations for several specific experiment types:</p><ul><li><code>RelaxationExperiment</code>: For relaxation measurements</li><li><code>HetNOEExperiment</code>: For heteronuclear NOE measurements</li><li><code>PREExperiment</code>: For paramagnetic relaxation enhancement measurements</li></ul><p>Each implementation specialises the simulation and fitting behaviour for its specific experiment type while inheriting the common functionality from the abstract type.</p><h2 id="Guide:-Creating-a-New-Experiment-Type"><a class="docs-heading-anchor" href="#Guide:-Creating-a-New-Experiment-Type">Guide: Creating a New Experiment Type</a><a id="Guide:-Creating-a-New-Experiment-Type-1"></a><a class="docs-heading-anchor-permalink" href="#Guide:-Creating-a-New-Experiment-Type" title="Permalink"></a></h2><p>Here&#39;s a step-by-step guide to implementing a new type of NMR experiment:</p><ol><li><p><strong>Choose Base Type</strong></p><ul><li>Inherit from <code>FixedPeakExperiment</code> if peak positions are constant between spectra</li><li>Inherit from <code>MovingPeakExperiment</code> if peak positions can vary</li></ul></li><li><p><strong>Define Structure</strong></p><pre><code class="language-julia hljs">struct MyNewExperiment &lt;: FixedPeakExperiment
    # Required fields
    specdata
    peaks
    clusters
    touched
    isfitting
    xradius
    yradius
    state
    
    # Experiment-specific fields
    my_special_parameter
end</code></pre></li><li><p><strong>Constructor</strong></p><ul><li>Create a constructor that initializes all required fields</li><li>Set up observables using <code>setupexptobservables!</code></li><li>Initialize experiment-specific parameters</li></ul></li><li><p><strong>Core Analysis Functions</strong></p><ul><li>Implement <code>addpeak!</code> to set up experiment-specific peak parameters<pre><code class="language-julia hljs">function addpeak!(expt::MyNewExperiment, initialposition::Point2f, label=&quot;&quot;)
    # Create basic peak
    newpeak = Peak(initialposition, label)
    
    # Add experiment-specific parameters
    newpeak.parameters[:my_param] = Parameter(&quot;My Parameter&quot;, initial_value)
    
    # Add post-fit parameters that will be saved in results
    newpeak.postparameters[:final_result] = Parameter(&quot;Final Result&quot;, 0.0)
    
    push!(expt.peaks[], newpeak)
    notify(expt.peaks)
end</code></pre></li><li>Implement <code>simulate!</code> for your specific peak shapes/behavior</li><li>Implement <code>postfit!</code> to calculate final parameters from fit results</li></ul></li><li><p><strong>Information Functions</strong></p><ul><li>Implement <code>slicelabel</code> for spectrum navigation</li><li>Implement <code>peakinfotext</code> to show fit results</li><li>Implement <code>experimentinfo</code> to show experiment details</li></ul></li><li><p><strong>Visualization Functions</strong></p><ul><li>Implement <code>makepeakplot!</code> for the interactive GUI<pre><code class="language-julia hljs">function makepeakplot!(gui, state, expt::MyNewExperiment)
    # Create appropriate plot(s) for your data
    gui[:axpeakplot] = ax = Axis(gui[:panelpeakplot][1,1],
                               xlabel=&quot;My X Label&quot;,
                               ylabel=&quot;My Y Label&quot;)
    # Add plot elements
    plot!(ax, ...)
end</code></pre></li><li>Implement <code>save_peak_plots!</code> for publication figures<pre><code class="language-julia hljs">function save_peak_plots!(expt::MyNewExperiment, folder::AbstractString)
    CairoMakie.activate!()
    for peak in expt.peaks[]
        fig = Figure()
        # Create publication-quality figure
        save(joinpath(folder, &quot;peak_$(peak.label[]).pdf&quot;), fig)
    end
    GLMakie.activate!()
end</code></pre></li></ul></li><li><p><strong>Optional Overrides</strong></p><ul><li>Override <code>mask!</code> only if you need non-elliptical peak shapes</li><li>Override clustering functions only if you need special peak grouping</li><li>Override other default implementations only if needed</li></ul></li></ol><p>Remember:</p><ul><li>Post-fit parameters (<code>postparameters</code>) are what get saved in results files</li><li>Peak parameters (<code>parameters</code>) are used during fitting</li><li>Use the existing implementations (RelaxationExperiment, HetNOEExperiment, PREExperiment) as templates</li><li>Most functionality can be inherited from the abstract type</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tutorials/r1rho/">« R1ρ analysis</a><a class="docs-footer-nextpage" href="../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 10 July 2025 09:22">Thursday 10 July 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
